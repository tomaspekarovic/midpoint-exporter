name: Build & Release (Linux)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  ENTRYPOINT: exporter.py
  BINARY_NAME: midpoint-exporter

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Verify entrypoint exists
        run: |
          if [ ! -f "$ENTRYPOINT" ]; then
            echo "ERROR: $ENTRYPOINT not found in repo root."
            echo "Repo tree:"
            ls -lah
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pyinstaller requests prometheus_client
          fi

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name "$BINARY_NAME" "$ENTRYPOINT"
          ls -lah dist

      - name: Package & checksums
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          ARCH="$(python -c 'import platform; m=platform.machine().lower(); print("arm64" if m in ("aarch64","arm64") else ("amd64" if m in ("x86_64","amd64") else m))')"
          OUT="${BINARY_NAME}-linux-${ARCH}"
          cp "dist/${BINARY_NAME}" "$OUT"
          chmod +x "$OUT"
          sha256sum "$OUT" > "SHA256SUM-linux-${ARCH}.txt"
          echo "bin=$OUT" >> "$GITHUB_OUTPUT"
          echo "sum=SHA256SUM-linux-${ARCH}.txt" >> "$GITHUB_OUTPUT"

      - name: Create/Update GitHub Release (attach files)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.pack.outputs.BIN }}
            ${{ steps.pack.outputs.SUM }}
